<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Visits Backoffice - AgriTech Hydroponics</title>
    <style>
        /*
         * STYLING: Matches the existing dashboard.html design system.
         * Purple gradient background, white cards with border-radius: 12px,
         * system font stack, status badges, hover transforms.
         */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* ── Header ─────────────────────────────────────── */
        header {
            background: white;
            padding: 24px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { color: #667eea; font-size: 28px; }
        header .subtitle { color: #666; font-size: 13px; margin-top: 4px; }
        .header-links a {
            color: #667eea;
            text-decoration: none;
            margin-left: 16px;
            font-size: 14px;
            font-weight: 500;
        }
        .header-links a:hover { text-decoration: underline; }

        /* ── Tabs ───────────────────────────────────────── */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px 8px 0 0;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.35); }
        .tab-btn.active { background: white; color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ── Cards ──────────────────────────────────────── */
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .card-title {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        /* ── Grid Layouts ───────────────────────────────── */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ── KPI Cards ──────────────────────────────────── */
        .kpi-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        .kpi-label { font-size: 13px; color: #888; margin-top: 4px; }
        .kpi-delta {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .delta-positive { background: #d4edda; color: #155724; }
        .delta-negative { background: #f8d7da; color: #721c24; }
        .delta-neutral { background: #e2e3e5; color: #383d41; }

        /* ── Status Badges ──────────────────────────────── */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-routine { background: #d4edda; color: #155724; }
        .badge-emergency { background: #f8d7da; color: #721c24; }
        .badge-follow_up { background: #fff3cd; color: #856404; }
        .badge-audit { background: #cce5ff; color: #004085; }
        .badge-bronze { background: #f0e6d3; color: #8a6d3b; }
        .badge-silver { background: #e8e8e8; color: #555; }
        .badge-gold { background: #fff3cd; color: #856404; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-completed { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }

        /* ── Stars ──────────────────────────────────────── */
        .stars { color: #f5a623; font-size: 18px; letter-spacing: 2px; }
        .stars-small { font-size: 14px; }
        .star-input { cursor: pointer; font-size: 28px; color: #ddd; transition: color 0.15s; }
        .star-input:hover, .star-input.active { color: #f5a623; }

        /* ── Charts (pure CSS, no libraries) ─────────────── */
        /*
         * Educational: CSS-only charts avoid loading a charting library (Chart.js = 200KB).
         * Bar charts use dynamic width%. Donut charts use conic-gradient().
         */
        .bar-chart { display: flex; flex-direction: column; gap: 8px; }
        .bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bar-label { min-width: 60px; font-size: 12px; color: #666; text-align: right; }
        .bar-track {
            flex: 1;
            height: 24px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-size: 11px;
            color: white;
            font-weight: 600;
        }

        .donut-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 16px;
        }
        .donut-hole {
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        .donut-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #666;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ── Tables ─────────────────────────────────────── */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; text-align: left; font-size: 13px; }
        th {
            border-bottom: 2px solid #eee;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }
        th:hover { color: #667eea; }
        th .sort-arrow { font-size: 10px; margin-left: 4px; }
        td { border-bottom: 1px solid #f0f0f0; }
        tr:hover td { background: #f8f9ff; }

        /* ── Expandable Row Detail ──────────────────────── */
        .row-detail {
            display: none;
            padding: 16px 12px;
            background: #f8f9ff;
            font-size: 13px;
        }
        .row-detail.open { display: table-row; }
        .row-detail td { border-bottom: 2px solid #eee; }
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .detail-section h4 {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .detail-section p { color: #555; line-height: 1.5; }

        /* ── Form Styles ────────────────────────────────── */
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
        }
        textarea { resize: vertical; }

        /* ── Buttons ────────────────────────────────────── */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover { opacity: 0.9; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-outline {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
        }
        .btn-outline:hover { background: #667eea; color: white; }

        /* ── Filter Bar ─────────────────────────────────── */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .filter-bar input,
        .filter-bar select {
            width: auto;
            min-width: 140px;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* ── Pagination ─────────────────────────────────── */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }
        .pagination button {
            padding: 6px 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .pagination button:hover { border-color: #667eea; color: #667eea; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.4; cursor: default; }
        .page-info { font-size: 13px; color: #666; }

        /* ── Tags Input ─────────────────────────────────── */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 42px;
            cursor: text;
        }
        .tags-container:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
        }
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 500;
        }
        .tag-remove {
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            opacity: 0.8;
        }
        .tag-remove:hover { opacity: 1; }
        .tags-input {
            border: none;
            outline: none;
            padding: 4px;
            font-size: 14px;
            flex: 1;
            min-width: 100px;
        }

        /* ── Issues Dynamic List ────────────────────────── */
        .issue-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .issue-row input { flex: 2; }
        .issue-row select { flex: 1; }
        .issue-remove {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }

        /* ── Toggle Switch ──────────────────────────────── */
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; }
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: #ddd;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle.active { background: #667eea; }
        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle.active::after { transform: translateX(22px); }
        .follow-up-fields { display: none; margin-top: 12px; }
        .follow-up-fields.visible { display: block; }

        /* ── Sensor Context Panel ───────────────────────── */
        .sensor-panel {
            background: #f8f9ff;
            border: 1px solid #e0e4f5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 18px;
        }
        .sensor-panel .card-title { margin-bottom: 8px; }
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        .sensor-reading {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            background: white;
        }
        .sensor-reading .value { font-size: 22px; font-weight: bold; }
        .sensor-reading .unit { font-size: 11px; color: #888; }
        .reading-ok .value { color: #28a745; }
        .reading-warn .value { color: #ffc107; }
        .reading-danger .value { color: #dc3545; }

        /* ── Crop Checkboxes ────────────────────────────── */
        .crop-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 8px;
        }
        .crop-check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9ff;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        .crop-check-item:hover { background: #eef0ff; }
        .crop-check-item input[type="checkbox"] { accent-color: #667eea; }

        /* ── Toast Notification ──────────────────────────── */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 14px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }

        /* ── Activity Feed ──────────────────────────────── */
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .activity-body { flex: 1; }
        .activity-title { font-size: 14px; font-weight: 600; color: #333; }
        .activity-meta { font-size: 12px; color: #888; margin-top: 2px; }

        /* ── Loading Spinner ─────────────────────────────── */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #888;
            gap: 10px;
        }

        /* ── Responsive ─────────────────────────────────── */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-bar input, .filter-bar select { width: 100%; }
            header { flex-direction: column; gap: 12px; text-align: center; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- Header -->
    <header>
        <div>
            <h1>Site Visits Backoffice</h1>
            <div class="subtitle">Field inspection management &mdash; API consumer pattern demo</div>
        </div>
        <div class="header-links">
            <a href="/business">Business Dashboard</a>
            <a href="/api/docs">API Docs</a>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
        <button class="tab-btn" onclick="switchTab('report')">New Field Report</button>
        <button class="tab-btn" onclick="switchTab('history')">Visit History</button>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         TAB 1: DASHBOARD
         Combines visit analytics (from /api/site-visits/dashboard)
         with live system data (from existing /api/crops, /api/business/dashboard, etc.)
         ═══════════════════════════════════════════════════════════════ -->
    <div id="tab-dashboard" class="tab-content active">
        <!-- Row 1: KPI Cards -->
        <div class="grid-4" id="kpi-cards">
            <div class="card">
                <div class="card-title">Total Site Visits</div>
                <div class="kpi-value" id="kpi-total">--</div>
                <div class="kpi-label">all time</div>
            </div>
            <div class="card">
                <div class="card-title">Visits This Month</div>
                <div>
                    <span class="kpi-value" id="kpi-month">--</span>
                    <span class="kpi-delta" id="kpi-month-delta"></span>
                </div>
                <div class="kpi-label">current month</div>
            </div>
            <div class="card">
                <div class="card-title">Pending Follow-ups</div>
                <div class="kpi-value" id="kpi-followups" style="color: #888;">--</div>
                <div class="kpi-label">requiring action</div>
            </div>
            <div class="card">
                <div class="card-title">Avg Site Rating</div>
                <div class="stars" id="kpi-stars">-----</div>
                <div class="kpi-label" id="kpi-rating-num"></div>
            </div>
        </div>

        <!-- Row 2: Live System Status (from existing APIs) -->
        <div class="grid-3" id="live-status">
            <div class="card">
                <div class="card-title">Active Crops</div>
                <div id="live-crops"><div class="loading-overlay"><span class="spinner"></span> Loading crops...</div></div>
            </div>
            <div class="card">
                <div class="card-title">Sensor Health</div>
                <div id="live-sensors"><div class="loading-overlay"><span class="spinner"></span> Loading sensors...</div></div>
            </div>
            <div class="card">
                <div class="card-title">Client Health</div>
                <div id="live-clients"><div class="loading-overlay"><span class="spinner"></span> Loading clients...</div></div>
            </div>
        </div>

        <!-- Row 3: Visit Analytics Charts -->
        <div class="grid-3" id="chart-row">
            <div class="card">
                <div class="card-title">Visits by Month (last 6)</div>
                <div id="chart-monthly" class="bar-chart"></div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="card-title">Visits by Type</div>
                <div id="chart-type-donut"></div>
            </div>
            <div class="card">
                <div class="card-title">Rating Distribution</div>
                <div id="chart-ratings" class="bar-chart"></div>
            </div>
        </div>

        <!-- Row 4: Data Tables -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">Top Visited Clients</div>
                <table>
                    <thead>
                        <tr><th>Client</th><th>Visits</th><th>Last Visit</th><th>Health</th></tr>
                    </thead>
                    <tbody id="top-clients-table"></tbody>
                </table>
            </div>
            <div class="card">
                <div class="card-title">Recent Activity</div>
                <div id="recent-activity"></div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         TAB 2: NEW FIELD REPORT
         Demonstrates the API consumer pattern: on tab load, the form
         fetches data from multiple APIs in parallel to populate dropdowns
         and show live context.

         Educational: This is how a real frontend works against an API.
         The form doesn't hardcode values - it discovers them at runtime
         by calling the API. If a new crop batch is added, it appears
         automatically in the form without code changes.
         ═══════════════════════════════════════════════════════════════ -->
    <div id="tab-report" class="tab-content">
        <div class="card" style="max-width: 900px; margin: 0 auto;">
            <div class="card-title">New Field Report</div>

            <form id="visit-form" onsubmit="submitVisit(event)">
                <!-- Row: Date + Inspector -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="visit-date">Visit Date</label>
                        <input type="date" id="visit-date" required>
                    </div>
                    <div class="form-group">
                        <label for="inspector-name">Inspector Name</label>
                        <input type="text" id="inspector-name" list="inspector-list" placeholder="Enter inspector name" required>
                        <datalist id="inspector-list"></datalist>
                    </div>
                </div>

                <!-- Row: Client + Visit Type -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-select">Client</label>
                        <select id="client-select">
                            <option value="">-- Select client --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="visit-type">Visit Type</label>
                        <select id="visit-type" required>
                            <option value="routine">Routine</option>
                            <option value="emergency">Emergency</option>
                            <option value="follow_up">Follow-up</option>
                            <option value="audit">Audit</option>
                        </select>
                    </div>
                </div>

                <!-- Facility Name -->
                <div class="form-group">
                    <label for="facility-name">Facility Name</label>
                    <input type="text" id="facility-name" placeholder="e.g. Greenhouse A, Vertical Farm Unit 3">
                </div>

                <!-- Live Sensor Context Panel -->
                <!--
                    Educational: This panel is READ-ONLY. It shows current sensor readings
                    from /api/data/latest so the inspector can see the live state of the system.
                    The data is also snapshot into the visit record when submitted, creating
                    a point-in-time record (sensor values change, but the report captures
                    what they were at visit time).
                -->
                <div class="sensor-panel">
                    <div class="card-title">Live Sensor Readings (from /api/data/latest)</div>
                    <div class="sensor-grid" id="sensor-context">
                        <div class="loading-overlay"><span class="spinner"></span> Loading sensors...</div>
                    </div>
                    <div style="font-size: 11px; color: #888; margin-top: 8px;">
                        These readings will be snapshot into the visit record as a point-in-time reference.
                    </div>
                </div>

                <!-- Crop Batches Inspected -->
                <!--
                    Educational: These checkboxes are populated from GET /api/crops.
                    The frontend doesn't know what crops exist - it discovers them
                    from the API at runtime. This is the API consumer pattern.
                -->
                <div class="form-group">
                    <label>Crop Batches Inspected (from /api/crops)</label>
                    <div class="crop-checklist" id="crop-checkboxes">
                        <div class="loading-overlay"><span class="spinner"></span> Loading crops...</div>
                    </div>
                </div>

                <!-- Zones Inspected (tag input) -->
                <div class="form-group">
                    <label>Zones Inspected</label>
                    <div class="tags-container" id="zones-tags" onclick="document.getElementById('zone-input').focus()">
                        <input type="text" class="tags-input" id="zone-input" placeholder="Type zone name + Enter">
                    </div>
                </div>

                <!-- Observations -->
                <div class="form-group">
                    <label for="observations">Observations</label>
                    <textarea id="observations" rows="4" placeholder="General observations about the site visit..."></textarea>
                </div>

                <!-- Issues Found (dynamic rows) -->
                <div class="form-group">
                    <label>Issues Found</label>
                    <div id="issues-list"></div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addIssueRow()" style="margin-top: 8px;">+ Add Issue</button>
                </div>

                <!-- Actions Taken -->
                <div class="form-group">
                    <label for="actions-taken">Actions Taken</label>
                    <textarea id="actions-taken" rows="3" placeholder="Describe actions taken during the visit..."></textarea>
                </div>

                <!-- Follow-up Toggle -->
                <div class="form-group">
                    <label>Follow-up Required</label>
                    <div class="toggle-wrapper">
                        <div class="toggle" id="followup-toggle" onclick="toggleFollowUp()"></div>
                        <span id="followup-label" style="font-size: 14px; color: #888;">No</span>
                    </div>
                    <div class="follow-up-fields" id="followup-fields">
                        <div class="form-row" style="margin-top: 12px;">
                            <div class="form-group">
                                <label for="followup-date">Follow-up Date</label>
                                <input type="date" id="followup-date">
                            </div>
                            <div class="form-group">
                                <label for="followup-notes">Follow-up Notes</label>
                                <textarea id="followup-notes" rows="2" placeholder="What needs to be done on follow-up..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Notes -->
                <div class="form-group">
                    <label for="photo-notes">Photo Notes</label>
                    <textarea id="photo-notes" rows="2" placeholder="Reference any photos taken (e.g. 'IMG_001: mold on tray B3')"></textarea>
                </div>

                <!-- Overall Rating (star input) -->
                <div class="form-group">
                    <label>Overall Rating</label>
                    <div id="star-rating" style="display: flex; gap: 4px;"></div>
                </div>

                <!-- Submit -->
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" id="submit-btn">Submit Visit Report</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════
         TAB 3: VISIT HISTORY
         Data exploration with search, filters, sorting, expandable rows,
         CSV export, and pagination.
         ═══════════════════════════════════════════════════════════════ -->
    <div id="tab-history" class="tab-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="card-title" style="margin-bottom: 0;">Visit History</div>
                <button class="btn btn-outline btn-sm" onclick="exportCSV()">Export CSV</button>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <!--
                    Educational: The search input uses debounce() to avoid firing an API
                    call on every keystroke. Without debounce, typing "John" would send
                    4 requests ("J", "Jo", "Joh", "John"). Debounce waits until the user
                    stops typing (300ms) before sending. This reduces server load and
                    improves UX by not showing flickering partial results.
                -->
                <input type="text" class="search-input" id="history-search" placeholder="Search visits..." oninput="debouncedSearch()">
                <select id="filter-type" onchange="loadHistory()">
                    <option value="">All Types</option>
                    <option value="routine">Routine</option>
                    <option value="emergency">Emergency</option>
                    <option value="follow_up">Follow-up</option>
                    <option value="audit">Audit</option>
                </select>
                <input type="date" id="filter-from" onchange="loadHistory()" title="Date from">
                <input type="date" id="filter-to" onchange="loadHistory()" title="Date to">
                <select id="filter-inspector" onchange="loadHistory()">
                    <option value="">All Inspectors</option>
                </select>
                <select id="filter-followup" onchange="loadHistory()">
                    <option value="">All Follow-ups</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                </select>
            </div>

            <!-- Sortable Table -->
            <div style="overflow-x: auto;">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th onclick="sortHistory('visit_date')">Date <span class="sort-arrow" id="sort-visit_date"></span></th>
                            <th onclick="sortHistory('inspector_name')">Inspector <span class="sort-arrow" id="sort-inspector_name"></span></th>
                            <th>Client</th>
                            <th onclick="sortHistory('visit_type')">Type <span class="sort-arrow" id="sort-visit_type"></span></th>
                            <th onclick="sortHistory('overall_rating')">Rating <span class="sort-arrow" id="sort-overall_rating"></span></th>
                            <th>Issues</th>
                            <th>Follow-up</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>

            <div class="pagination" id="pagination-controls"></div>
        </div>
    </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/*
 * ═══════════════════════════════════════════════════════════════════════
 * SITE VISITS BACKOFFICE - JavaScript
 *
 * Educational: This file demonstrates the API consumer pattern.
 * The frontend calls existing API endpoints to populate itself,
 * treating the backend as a service contract. It doesn't know about
 * the database schema or implementation - only the API response shapes.
 *
 * Key patterns demonstrated:
 * 1. Promise.all for parallel API calls (form loading)
 * 2. Debounce for search input (performance)
 * 3. Client-side CSV generation (Blob + download)
 * 4. CSS-only charts (conic-gradient donut, width% bars)
 * 5. Sortable/filterable tables with pagination
 * ═══════════════════════════════════════════════════════════════════════
 */

// ── State ─────────────────────────────────────────────────────────
let currentTab = 'dashboard';
let historyState = { page: 1, sort: 'visit_date', sortDir: 'desc' };
let sensorSnapshot = {};   // captured at form load for visit record
let selectedRating = 3;
let zoneTags = [];

// ── API Helper ────────────────────────────────────────────────────
/*
 * Educational: All API calls go through this helper. It handles JSON
 * parsing and error responses uniformly. In a production app you'd also
 * handle auth tokens, retries, and rate limiting here.
 */
async function api(path, options = {}) {
    const resp = await fetch(path, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
    return data;
}

// ── Tab Switching ─────────────────────────────────────────────────
function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', ['dashboard', 'report', 'history'][i] === tab);
    });
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');

    if (tab === 'dashboard') loadDashboard();
    if (tab === 'report') loadFormData();
    if (tab === 'history') loadHistory();
}

// ═══════════════════════════════════════════════════════════════════
// TAB 1: DASHBOARD
// ═══════════════════════════════════════════════════════════════════

async function loadDashboard() {
    /*
     * Educational: We fetch from multiple APIs in parallel using Promise.allSettled.
     * Promise.allSettled (vs Promise.all) ensures that if one API fails,
     * the others still render. This is important when aggregating data
     * from different services - a sensor API outage shouldn't break the
     * entire dashboard.
     */
    const [visitStats, cropsResult, businessResult, calibResult] = await Promise.allSettled([
        api('/api/site-visits/dashboard'),
        api('/api/crops'),
        api('/api/business/dashboard'),
        api('/api/calibrations/due'),
    ]);

    // Render visit KPIs
    if (visitStats.status === 'fulfilled') {
        const s = visitStats.value;
        renderKPIs(s.kpis);
        renderMonthlyChart(s.charts.monthly);
        renderTypeDonut(s.charts.by_type);
        renderRatingsChart(s.charts.ratings);
        renderTopClients(s.top_clients);
        renderRecentActivity(s.recent_activity);
    }

    // Render live crops status (from existing /api/crops)
    if (cropsResult.status === 'fulfilled') {
        renderLiveCrops(cropsResult.value.crops);
    } else {
        document.getElementById('live-crops').innerHTML = '<div style="color:#888; font-size:13px;">Could not load crop data</div>';
    }

    // Render live business status (from existing /api/business/dashboard)
    if (businessResult.status === 'fulfilled') {
        renderLiveBusiness(businessResult.value);
    } else {
        document.getElementById('live-sensors').innerHTML = '<div style="color:#888; font-size:13px;">Could not load sensor data</div>';
        document.getElementById('live-clients').innerHTML = '<div style="color:#888; font-size:13px;">Could not load client data</div>';
    }
}

function renderKPIs(kpis) {
    document.getElementById('kpi-total').textContent = kpis.total_visits;
    document.getElementById('kpi-month').textContent = kpis.visits_this_month;

    const deltaEl = document.getElementById('kpi-month-delta');
    const d = kpis.month_delta;
    if (d > 0) { deltaEl.textContent = '+' + d; deltaEl.className = 'kpi-delta delta-positive'; }
    else if (d < 0) { deltaEl.textContent = d; deltaEl.className = 'kpi-delta delta-negative'; }
    else { deltaEl.textContent = '0'; deltaEl.className = 'kpi-delta delta-neutral'; }

    const fuEl = document.getElementById('kpi-followups');
    fuEl.textContent = kpis.pending_followups;
    fuEl.style.color = kpis.pending_followups > 0 ? '#ffc107' : '#28a745';

    const starsEl = document.getElementById('kpi-stars');
    starsEl.innerHTML = renderStars(kpis.avg_rating);
    document.getElementById('kpi-rating-num').textContent = kpis.avg_rating + ' / 5';
}

function renderStars(rating, small = false) {
    const full = Math.floor(rating);
    const half = rating - full >= 0.5 ? 1 : 0;
    const empty = 5 - full - half;
    const cls = small ? 'stars stars-small' : 'stars';
    return '<span class="' + cls + '">' + '\u2605'.repeat(full) + (half ? '\u2606' : '') + '\u2606'.repeat(empty) + '</span>';
}

function renderMonthlyChart(data) {
    const container = document.getElementById('chart-monthly');
    if (!data.length) { container.innerHTML = '<div style="color:#888; font-size:13px; padding:20px;">No visit data yet</div>'; return; }

    const max = Math.max(...data.map(d => d.count), 1);
    container.innerHTML = data.map(d => `
        <div class="bar-row">
            <div class="bar-label">${d.month}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width: ${(d.count / max * 100)}%">${d.count}</div>
            </div>
        </div>
    `).join('');
}

function renderTypeDonut(data) {
    /*
     * Educational: conic-gradient() creates a pie/donut chart with pure CSS.
     * No chart library needed. We compute cumulative percentages and build
     * the gradient stops. A white circle overlay on top creates the "donut hole".
     */
    const container = document.getElementById('chart-type-donut');
    const total = data.reduce((s, d) => s + d.count, 0);
    if (!total) { container.innerHTML = '<div style="color:#888; font-size:13px; padding:20px;">No data</div>'; return; }

    const colors = { routine: '#28a745', emergency: '#dc3545', follow_up: '#ffc107', audit: '#007bff' };
    let gradientParts = [];
    let cumulative = 0;

    data.forEach(d => {
        const pct = (d.count / total) * 100;
        const color = colors[d.type] || '#888';
        gradientParts.push(`${color} ${cumulative}% ${cumulative + pct}%`);
        cumulative += pct;
    });

    const legendHtml = data.map(d => `
        <div class="legend-item">
            <div class="legend-dot" style="background: ${colors[d.type] || '#888'}"></div>
            ${d.type.replace('_', '-')} (${d.count})
        </div>
    `).join('');

    container.innerHTML = `
        <div class="donut-chart" style="background: conic-gradient(${gradientParts.join(', ')})">
            <div class="donut-hole">${total}</div>
        </div>
        <div class="donut-legend">${legendHtml}</div>
    `;
}

function renderRatingsChart(data) {
    const container = document.getElementById('chart-ratings');
    if (!data.length) { container.innerHTML = '<div style="color:#888; font-size:13px; padding:20px;">No ratings yet</div>'; return; }

    const max = Math.max(...data.map(d => d.count), 1);
    // Ensure all 5 ratings shown
    const ratingMap = {};
    data.forEach(d => ratingMap[d.rating] = d.count);

    let html = '';
    for (let r = 5; r >= 1; r--) {
        const count = ratingMap[r] || 0;
        html += `
            <div class="bar-row">
                <div class="bar-label">${'\u2605'.repeat(r)}</div>
                <div class="bar-track">
                    <div class="bar-fill" style="width: ${count ? (count / max * 100) : 0}%">${count || ''}</div>
                </div>
            </div>
        `;
    }
    container.innerHTML = html;
}

function renderLiveCrops(crops) {
    const el = document.getElementById('live-crops');
    if (!crops || !crops.length) {
        el.innerHTML = '<div style="font-size:13px; color:#888;">No active crops</div>';
        return;
    }
    // Count by stage
    const stages = {};
    crops.forEach(c => {
        const stage = c.current_stage || 'unknown';
        stages[stage] = (stages[stage] || 0) + 1;
    });

    const harvestReady = crops.filter(c => c.current_stage === 'harvest_ready').length;

    let html = `<div style="font-size: 28px; font-weight: bold; color: #667eea;">${crops.length}</div>`;
    html += '<div style="font-size:12px; color:#888; margin-bottom: 8px;">active batches</div>';
    html += Object.entries(stages).map(([stage, count]) =>
        `<div style="font-size:12px; display:flex; justify-content:space-between; padding:2px 0;">
            <span style="color:#666;">${stage.replace('_', ' ')}</span>
            <span style="font-weight:600;">${count}</span>
        </div>`
    ).join('');
    if (harvestReady > 0) {
        html += `<div style="margin-top:8px;"><span class="badge badge-completed">${harvestReady} harvest ready</span></div>`;
    }
    el.innerHTML = html;
}

function renderLiveBusiness(data) {
    // Sensor Health
    const sensorEl = document.getElementById('live-sensors');
    const sh = data.sensor_health || {};
    const online = sh.sensors_online || 0;
    const total = sh.total_sensors || 0;
    const uptime = sh.uptime_percentage || 0;
    const overdue = (data.calibration_status && data.calibration_status.overdue_count) || 0;

    let sensorHtml = `<div style="font-size: 28px; font-weight: bold; color: ${online === total ? '#28a745' : '#ffc107'};">${online}/${total}</div>`;
    sensorHtml += '<div style="font-size:12px; color:#888; margin-bottom: 8px;">sensors online</div>';
    sensorHtml += `<div style="font-size:12px; color:#666;">Uptime: <strong>${uptime}%</strong></div>`;
    if (overdue > 0) {
        sensorHtml += `<div style="margin-top:6px;"><span class="badge badge-warning">${overdue} calibration overdue</span></div>`;
    }
    sensorEl.innerHTML = sensorHtml;

    // Client Health
    const clientEl = document.getElementById('live-clients');
    const ch = data.client_health || {};
    const avgHealth = ch.average_health || 0;
    const needsAttention = (ch.clients_needing_attention && ch.clients_needing_attention.length) || 0;
    const activeClients = ch.active_clients || 0;

    let clientHtml = `<div style="font-size: 28px; font-weight: bold; color: ${avgHealth >= 80 ? '#28a745' : avgHealth >= 60 ? '#ffc107' : '#dc3545'};">${avgHealth}</div>`;
    clientHtml += '<div style="font-size:12px; color:#888; margin-bottom: 8px;">avg health score</div>';
    clientHtml += `<div style="font-size:12px; color:#666;">Active clients: <strong>${activeClients}</strong></div>`;
    if (needsAttention > 0) {
        clientHtml += `<div style="margin-top:6px;"><span class="badge badge-warning">${needsAttention} need attention</span></div>`;
    }
    clientEl.innerHTML = clientHtml;
}

function renderTopClients(clients) {
    const tbody = document.getElementById('top-clients-table');
    if (!clients.length) { tbody.innerHTML = '<tr><td colspan="4" style="color:#888; text-align:center;">No visit data yet</td></tr>'; return; }
    tbody.innerHTML = clients.map(c => `
        <tr>
            <td><strong>${esc(c.company_name)}</strong></td>
            <td>${c.visit_count}</td>
            <td>${c.last_visit || '-'}</td>
            <td><span class="badge ${c.health_score >= 80 ? 'badge-routine' : c.health_score >= 60 ? 'badge-follow_up' : 'badge-emergency'}">${c.health_score}</span></td>
        </tr>
    `).join('');
}

function renderRecentActivity(items) {
    const el = document.getElementById('recent-activity');
    if (!items.length) { el.innerHTML = '<div style="color:#888; font-size:13px; padding:16px;">No visits yet. Create your first field report!</div>'; return; }

    const icons = { routine: '\u{1F50D}', emergency: '\u26A0\uFE0F', follow_up: '\u{1F501}', audit: '\u{1F4CB}' };
    const colors = { routine: '#d4edda', emergency: '#f8d7da', follow_up: '#fff3cd', audit: '#cce5ff' };

    el.innerHTML = items.slice(0, 8).map(v => {
        const issueCount = (v.issues_found || []).length;
        return `
        <div class="activity-item">
            <div class="activity-icon" style="background: ${colors[v.visit_type] || '#eee'};">${icons[v.visit_type] || '\u{1F4C4}'}</div>
            <div class="activity-body">
                <div class="activity-title">
                    ${esc(v.inspector_name)} &mdash; ${esc(v.client_name || 'No client')}
                    <span class="badge badge-${v.visit_type}" style="margin-left: 6px;">${v.visit_type.replace('_', '-')}</span>
                </div>
                <div class="activity-meta">
                    ${v.visit_date} &middot; ${renderStars(v.overall_rating, true)}
                    ${issueCount > 0 ? ' &middot; ' + issueCount + ' issue(s)' : ''}
                    ${v.follow_up_required && !v.follow_up_completed ? ' &middot; <span style="color:#ffc107;">follow-up pending</span>' : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}


// ═══════════════════════════════════════════════════════════════════
// TAB 2: NEW FIELD REPORT (API Consumer)
// ═══════════════════════════════════════════════════════════════════

async function loadFormData() {
    /*
     * Educational: Promise.all fetches from 3 APIs in parallel.
     * This is faster than sequential fetches. The form can't render
     * until it knows what clients, crops, and sensors exist.
     * Promise.allSettled ensures partial failures don't break everything.
     */
    const [clientsResult, cropsResult, sensorResult, dashResult] = await Promise.allSettled([
        api('/api/site-visits/clients'),
        api('/api/crops'),
        api('/api/data/latest'),
        api('/api/site-visits/dashboard'),
    ]);

    // Populate client dropdown
    if (clientsResult.status === 'fulfilled') {
        const select = document.getElementById('client-select');
        const clients = clientsResult.value.clients || [];
        // Keep existing first option
        select.innerHTML = '<option value="">-- Select client --</option>';
        clients.forEach(c => {
            const tierBadge = c.service_tier ? ` [${c.service_tier}]` : '';
            select.innerHTML += `<option value="${c.id}">${esc(c.company_name)}${tierBadge}</option>`;
        });
    }

    // Populate crop checkboxes
    if (cropsResult.status === 'fulfilled') {
        const container = document.getElementById('crop-checkboxes');
        const crops = cropsResult.value.crops || [];
        if (!crops.length) {
            container.innerHTML = '<div style="color:#888; font-size:13px;">No active crop batches</div>';
        } else {
            container.innerHTML = crops.map(c => `
                <label class="crop-check-item">
                    <input type="checkbox" value="${c.id}" data-variety="${esc(c.variety || '')}" data-stage="${esc(c.current_stage || '')}">
                    <span>
                        <strong>${esc(c.batch_code || 'Batch #' + c.id)}</strong>
                        &mdash; ${esc(c.variety || 'unknown')}
                        <span class="badge badge-routine" style="margin-left: 4px;">${(c.current_stage || '').replace('_', ' ')}</span>
                    </span>
                </label>
            `).join('');
        }
    } else {
        document.getElementById('crop-checkboxes').innerHTML = '<div style="color:#888; font-size:13px;">Could not load crops</div>';
    }

    // Show live sensor readings
    if (sensorResult.status === 'fulfilled') {
        const latest = sensorResult.value.latest || {};
        sensorSnapshot = { ...latest }; // Capture for submission
        renderSensorContext(latest);
    } else {
        document.getElementById('sensor-context').innerHTML = '<div style="color:#888; font-size:13px;">Sensor data unavailable</div>';
    }

    // Populate inspector datalist from past visits
    if (dashResult.status === 'fulfilled' && dashResult.value.inspectors) {
        const datalist = document.getElementById('inspector-list');
        datalist.innerHTML = dashResult.value.inspectors.map(name =>
            `<option value="${esc(name)}">`
        ).join('');
    }

    // Set default date to today
    document.getElementById('visit-date').valueAsDate = new Date();

    // Init star rating
    initStarRating();
}

function renderSensorContext(data) {
    const container = document.getElementById('sensor-context');

    const readings = [
        { key: 'temperature', label: 'Temperature', unit: '\u00B0C', optimal: { min: 18, max: 28 } },
        { key: 'humidity', label: 'Humidity', unit: '%', optimal: { min: 50, max: 80 } },
        { key: 'pH', label: 'pH', unit: '', optimal: { min: 5.5, max: 6.5 } },
        { key: 'ec', label: 'EC', unit: 'mS/cm', optimal: { min: 1.0, max: 2.5 } },
        { key: 'light', label: 'Light', unit: 'lux', optimal: { min: 200, max: 800 } },
    ];

    const items = readings.filter(r => data[r.key] !== undefined).map(r => {
        const val = parseFloat(data[r.key]);
        let cls = 'reading-ok';
        if (val < r.optimal.min || val > r.optimal.max) cls = 'reading-warn';
        if (val < r.optimal.min * 0.8 || val > r.optimal.max * 1.2) cls = 'reading-danger';

        return `
            <div class="sensor-reading ${cls}">
                <div class="value">${val.toFixed(1)}</div>
                <div class="unit">${r.label} ${r.unit}</div>
            </div>
        `;
    });

    container.innerHTML = items.length ? items.join('') : '<div style="color:#888; font-size:13px;">No sensor readings available</div>';
}

// ── Star Rating Input ─────────────────────────────────────────────
function initStarRating() {
    const container = document.getElementById('star-rating');
    container.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star-input' + (i <= selectedRating ? ' active' : '');
        star.textContent = '\u2605';
        star.onclick = () => setRating(i);
        star.onmouseover = () => highlightStars(i);
        star.onmouseout = () => highlightStars(selectedRating);
        container.appendChild(star);
    }
}

function setRating(n) {
    selectedRating = n;
    highlightStars(n);
}

function highlightStars(n) {
    document.querySelectorAll('#star-rating .star-input').forEach((star, i) => {
        star.classList.toggle('active', i < n);
    });
}

// ── Zone Tags Input ───────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('zone-input');
    if (input) {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = input.value.trim();
                if (val && !zoneTags.includes(val)) {
                    zoneTags.push(val);
                    renderZoneTags();
                }
                input.value = '';
            }
        });
    }
});

function renderZoneTags() {
    const container = document.getElementById('zones-tags');
    const input = document.getElementById('zone-input');
    // Remove existing tags
    container.querySelectorAll('.tag').forEach(t => t.remove());
    // Add tags before input
    zoneTags.forEach((tag, i) => {
        const el = document.createElement('span');
        el.className = 'tag';
        el.innerHTML = `${esc(tag)} <span class="tag-remove" onclick="removeZoneTag(${i})">\u00D7</span>`;
        container.insertBefore(el, input);
    });
}

function removeZoneTag(index) {
    zoneTags.splice(index, 1);
    renderZoneTags();
}

// ── Issues Dynamic Rows ──────────────────────────────────────────
function addIssueRow() {
    const list = document.getElementById('issues-list');
    const row = document.createElement('div');
    row.className = 'issue-row';
    row.innerHTML = `
        <input type="text" placeholder="Issue description" class="issue-desc">
        <select class="issue-severity">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
        </select>
        <select class="issue-related">
            <option value="sensor">Sensor</option>
            <option value="crop">Crop</option>
            <option value="infrastructure">Infrastructure</option>
            <option value="other">Other</option>
        </select>
        <button type="button" class="issue-remove" onclick="this.parentElement.remove()">\u00D7</button>
    `;
    list.appendChild(row);
}

// ── Follow-up Toggle ──────────────────────────────────────────────
function toggleFollowUp() {
    const toggle = document.getElementById('followup-toggle');
    const fields = document.getElementById('followup-fields');
    const label = document.getElementById('followup-label');
    const isActive = toggle.classList.toggle('active');
    fields.classList.toggle('visible', isActive);
    label.textContent = isActive ? 'Yes' : 'No';
}

// ── Submit Visit ──────────────────────────────────────────────────
async function submitVisit(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        // Collect checked crop batches
        const checkedCrops = Array.from(document.querySelectorAll('#crop-checkboxes input[type="checkbox"]:checked'))
            .map(cb => parseInt(cb.value));

        // Collect issues
        const issues = Array.from(document.querySelectorAll('.issue-row')).map(row => ({
            description: row.querySelector('.issue-desc').value,
            severity: row.querySelector('.issue-severity').value,
            related_to: row.querySelector('.issue-related').value,
        })).filter(i => i.description.trim());

        const followUpActive = document.getElementById('followup-toggle').classList.contains('active');

        const payload = {
            visit_date: document.getElementById('visit-date').value,
            inspector_name: document.getElementById('inspector-name').value,
            client_id: document.getElementById('client-select').value ? parseInt(document.getElementById('client-select').value) : null,
            facility_name: document.getElementById('facility-name').value,
            visit_type: document.getElementById('visit-type').value,
            zones_inspected: zoneTags,
            crop_batches_checked: checkedCrops,
            sensor_readings_snapshot: sensorSnapshot,
            observations: document.getElementById('observations').value,
            issues_found: issues,
            actions_taken: document.getElementById('actions-taken').value,
            follow_up_required: followUpActive,
            follow_up_date: followUpActive ? document.getElementById('followup-date').value : null,
            follow_up_notes: followUpActive ? document.getElementById('followup-notes').value : '',
            overall_rating: selectedRating,
            photo_notes: document.getElementById('photo-notes').value,
        };

        await api('/api/site-visits', { method: 'POST', body: JSON.stringify(payload) });
        showToast('Visit report submitted successfully!', 'success');
        resetForm();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Visit Report';
    }
}

function resetForm() {
    document.getElementById('visit-form').reset();
    document.getElementById('visit-date').valueAsDate = new Date();
    document.getElementById('issues-list').innerHTML = '';
    zoneTags = [];
    renderZoneTags();
    selectedRating = 3;
    initStarRating();
    // Reset follow-up toggle
    document.getElementById('followup-toggle').classList.remove('active');
    document.getElementById('followup-fields').classList.remove('visible');
    document.getElementById('followup-label').textContent = 'No';
    // Uncheck crop checkboxes
    document.querySelectorAll('#crop-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}


// ═══════════════════════════════════════════════════════════════════
// TAB 3: VISIT HISTORY
// ═══════════════════════════════════════════════════════════════════

async function loadHistory() {
    const params = new URLSearchParams();
    params.set('page', historyState.page);
    params.set('per_page', '15');
    params.set('sort', historyState.sort);
    params.set('sort_dir', historyState.sortDir);

    const type = document.getElementById('filter-type').value;
    const from = document.getElementById('filter-from').value;
    const to = document.getElementById('filter-to').value;
    const inspector = document.getElementById('filter-inspector').value;
    const followup = document.getElementById('filter-followup').value;
    const search = document.getElementById('history-search').value;

    if (type) params.set('visit_type', type);
    if (from) params.set('date_from', from);
    if (to) params.set('date_to', to);
    if (inspector) params.set('inspector', inspector);
    if (followup) params.set('follow_up', followup);
    if (search) params.set('search', search);

    try {
        const data = await api('/api/site-visits?' + params.toString());
        renderHistoryTable(data.visits);
        renderPagination(data);
        updateSortArrows();

        // Populate inspector filter if empty
        const inspectorSelect = document.getElementById('filter-inspector');
        if (inspectorSelect.options.length <= 1) {
            const dashData = await api('/api/site-visits/dashboard');
            if (dashData.inspectors) {
                dashData.inspectors.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    inspectorSelect.appendChild(opt);
                });
            }
        }
    } catch (err) {
        document.getElementById('history-body').innerHTML =
            `<tr><td colspan="8" style="color:#dc3545; text-align:center;">Error loading visits: ${esc(err.message)}</td></tr>`;
    }
}

function renderHistoryTable(visits) {
    const tbody = document.getElementById('history-body');
    if (!visits.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="color:#888; text-align:center; padding:30px;">No visits found</td></tr>';
        return;
    }

    tbody.innerHTML = visits.map(v => {
        const issueCount = (v.issues_found || []).length;
        const fuStatus = !v.follow_up_required ? '-' :
            v.follow_up_completed ? '<span class="badge badge-completed">Done</span>' :
            '<span class="badge badge-pending">Pending</span>';

        return `
            <tr onclick="toggleDetail(${v.id})" style="cursor:pointer;" title="Click to expand">
                <td>${v.visit_date}</td>
                <td>${esc(v.inspector_name)}</td>
                <td>${esc(v.client_name || '-')}</td>
                <td><span class="badge badge-${v.visit_type}">${v.visit_type.replace('_', '-')}</span></td>
                <td>${renderStars(v.overall_rating, true)}</td>
                <td>${issueCount > 0 ? '<strong style="color:#dc3545;">' + issueCount + '</strong>' : '0'}</td>
                <td>${fuStatus}</td>
                <td>
                    ${v.follow_up_required && !v.follow_up_completed ?
                        `<button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); completeFollowUp(${v.id})">Complete</button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteVisit(${v.id})" style="margin-left:4px;" title="Delete">\u00D7</button>
                </td>
            </tr>
            <tr class="row-detail" id="detail-${v.id}">
                <td colspan="8">
                    <div class="detail-grid">
                        <div class="detail-section">
                            <h4>Observations</h4>
                            <p>${esc(v.observations || 'None recorded')}</p>
                        </div>
                        <div class="detail-section">
                            <h4>Actions Taken</h4>
                            <p>${esc(v.actions_taken || 'None recorded')}</p>
                        </div>
                        <div class="detail-section">
                            <h4>Issues Found</h4>
                            ${(v.issues_found || []).length ? v.issues_found.map(i =>
                                `<p><span class="badge badge-${i.severity === 'critical' ? 'emergency' : i.severity === 'high' ? 'follow_up' : 'routine'}">${i.severity}</span>
                                ${esc(i.description)} <em>(${i.related_to})</em></p>`
                            ).join('') : '<p>No issues</p>'}
                        </div>
                        <div class="detail-section">
                            <h4>Inspected</h4>
                            <p><strong>Zones:</strong> ${(v.zones_inspected || []).join(', ') || 'None'}</p>
                            <p><strong>Crops:</strong> ${(v.crop_batches_checked || []).length ? v.crop_batches_checked.join(', ') : 'None'}</p>
                            ${v.facility_name ? '<p><strong>Facility:</strong> ' + esc(v.facility_name) + '</p>' : ''}
                            ${v.photo_notes ? '<p><strong>Photos:</strong> ' + esc(v.photo_notes) + '</p>' : ''}
                        </div>
                        ${v.follow_up_required ? `
                        <div class="detail-section">
                            <h4>Follow-up</h4>
                            <p><strong>Date:</strong> ${v.follow_up_date || 'Not set'}</p>
                            <p>${esc(v.follow_up_notes || '')}</p>
                        </div>` : ''}
                        ${Object.keys(v.sensor_readings_snapshot || {}).length ? `
                        <div class="detail-section">
                            <h4>Sensor Snapshot at Visit</h4>
                            <p style="font-size:12px; color:#888;">Point-in-time sensor readings captured during this visit</p>
                            ${Object.entries(v.sensor_readings_snapshot).filter(([k]) => !k.startsWith('_')).map(([k, val]) =>
                                `<p>${k}: <strong>${val}</strong></p>`
                            ).join('')}
                        </div>` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function toggleDetail(id) {
    const row = document.getElementById('detail-' + id);
    if (row) row.classList.toggle('open');
}

// ── Sorting ───────────────────────────────────────────────────────
function sortHistory(col) {
    if (historyState.sort === col) {
        historyState.sortDir = historyState.sortDir === 'desc' ? 'asc' : 'desc';
    } else {
        historyState.sort = col;
        historyState.sortDir = 'desc';
    }
    historyState.page = 1;
    loadHistory();
}

function updateSortArrows() {
    document.querySelectorAll('.sort-arrow').forEach(el => el.textContent = '');
    const arrow = document.getElementById('sort-' + historyState.sort);
    if (arrow) arrow.textContent = historyState.sortDir === 'asc' ? '\u25B2' : '\u25BC';
}

// ── Pagination ────────────────────────────────────────────────────
function renderPagination(data) {
    const container = document.getElementById('pagination-controls');
    const { page, total_pages, total } = data;

    if (total_pages <= 1) { container.innerHTML = ''; return; }

    let html = `<button ${page <= 1 ? 'disabled' : ''} onclick="goPage(${page - 1})">&laquo; Prev</button>`;
    html += `<span class="page-info">Page ${page} of ${total_pages} (${total} visits)</span>`;
    html += `<button ${page >= total_pages ? 'disabled' : ''} onclick="goPage(${page + 1})">Next &raquo;</button>`;
    container.innerHTML = html;
}

function goPage(p) {
    historyState.page = p;
    loadHistory();
}

// ── Search Debounce ───────────────────────────────────────────────
/*
 * Educational: Debounce delays execution until the user stops typing.
 * Without it, every keystroke fires an API call. With 300ms debounce,
 * we wait until the user pauses, then fire ONE call. This reduces
 * server load from N calls (one per character) to ~1 call per word.
 */
let searchTimeout = null;
function debouncedSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        historyState.page = 1;
        loadHistory();
    }, 300);
}

// ── Follow-up Completion ──────────────────────────────────────────
async function completeFollowUp(id) {
    try {
        await api(`/api/site-visits/${id}/complete-follow-up`, { method: 'POST' });
        showToast('Follow-up marked as completed', 'success');
        loadHistory();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// ── Delete Visit ──────────────────────────────────────────────────
async function deleteVisit(id) {
    if (!confirm('Delete this visit record? This cannot be undone.')) return;
    try {
        await api(`/api/site-visits/${id}`, { method: 'DELETE' });
        showToast('Visit deleted', 'success');
        loadHistory();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// ── CSV Export ─────────────────────────────────────────────────────
/*
 * Educational: Client-side CSV generation avoids server load.
 * We fetch all data, convert to CSV format, create a Blob object,
 * and trigger a download via a temporary <a> element. The Blob API
 * creates a file-like object in memory without touching the server.
 */
async function exportCSV() {
    try {
        const data = await api('/api/site-visits/export');
        const visits = data.visits || [];
        if (!visits.length) { showToast('No data to export', 'error'); return; }

        const headers = ['ID', 'Date', 'Inspector', 'Client', 'Facility', 'Type', 'Rating',
                          'Observations', 'Issues Count', 'Actions Taken',
                          'Follow-up Required', 'Follow-up Date', 'Follow-up Completed'];
        const rows = visits.map(v => [
            v.id, v.visit_date, v.inspector_name, v.client_name || '', v.facility_name,
            v.visit_type, v.overall_rating, `"${(v.observations || '').replace(/"/g, '""')}"`,
            (v.issues_found || []).length, `"${(v.actions_taken || '').replace(/"/g, '""')}"`,
            v.follow_up_required ? 'Yes' : 'No', v.follow_up_date || '', v.follow_up_completed ? 'Yes' : 'No',
        ]);

        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `site-visits-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('CSV exported!', 'success');
    } catch (err) {
        showToast('Export error: ' + err.message, 'error');
    }
}


// ═══════════════════════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════════════════════

function esc(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast toast-' + type + ' show';
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ── Initial Load ──────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
});
</script>

</body>
</html>
