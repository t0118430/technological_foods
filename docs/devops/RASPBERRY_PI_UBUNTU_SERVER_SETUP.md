# Raspberry Pi Ubuntu Server Setup

Step-by-step guide to configure a Raspberry Pi running Ubuntu Server as the production host for the AgriTech Hydroponics API.

**Target hardware:** Raspberry Pi 4 - 4GB RAM, 64GB SD card

> **Note:** This guide uses `nano` as the text editor. If you prefer `vim`, replace `nano` with `vim` in all commands below.

---

## Table of Contents

1. [Flash Ubuntu Server](#1-flash-ubuntu-server)
2. [First Boot & Base Configuration](#2-first-boot--base-configuration)
3. [Install Docker](#3-install-docker)
4. [Install Python](#4-install-python)
5. [Create Data Directories](#5-create-data-directories)
6. [Clone the Project](#6-clone-the-project)
7. [Configure Environment Variables](#7-configure-environment-variables)
8. [Start Docker Services](#8-start-docker-services)
9. [Set Up the Python API](#9-set-up-the-python-api)
10. [Create systemd Service for the API](#10-create-systemd-service-for-the-api)
11. [Auto-start Docker Compose on Boot](#11-auto-start-docker-compose-on-boot)
12. [SD Card Longevity Optimizations](#12-sd-card-longevity-optimizations)
13. [Firewall](#13-firewall)
14. [SSH Hardening](#14-ssh-hardening)
15. [Verify Everything](#15-verify-everything)
16. [RAM Budget](#16-ram-budget)
17. [Port Reference](#17-port-reference)
18. [Maintenance Commands](#18-maintenance-commands)
19. [Troubleshooting](#19-troubleshooting)

---

## 1. Flash Ubuntu Server

1. Download **Ubuntu Server 24.04 LTS (64-bit)** for Raspberry Pi from `https://ubuntu.com/download/raspberry-pi`
2. Flash it to the SD card using **Raspberry Pi Imager** or **balenaEtcher**
3. If using Raspberry Pi Imager, pre-configure in the advanced options:
   - Hostname (e.g. `agritech`)
   - Enable SSH with password authentication
   - Set username and password
   - Configure WiFi (if not using Ethernet)
   - Set timezone to `Europe/Lisbon`

Insert the SD card into the Pi and power it on.

---

## 2. First Boot & Base Configuration

SSH into the Pi:

```bash
ssh <your-username>@agritech.local
```

Or by IP:

```bash
ssh <your-username>@192.168.x.x
```

Update the system:

```bash
sudo apt update && sudo apt upgrade -y
```

Install base packages:

```bash
sudo apt install -y git curl wget nano htop
```

Set timezone (if not done during flash):

```bash
sudo timedatectl set-timezone Europe/Lisbon
```

Verify:

```bash
timedatectl
```

Set a static IP (recommended for a server). Edit netplan:

```bash
sudo nano /etc/netplan/50-cloud-init.yaml
```

The default file uses DHCP and may include a WiFi section. To assign a static IP to Ethernet while keeping WiFi, change only the `eth0` block — replace `dhcp4: true` with a static address:

```yaml
# This file is generated by cloud-init on first boot.
# To prevent cloud-init from overwriting your changes, create:
#   /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
# with the content: network: {config: disabled}

network:
    ethernets:
        eth0:
            # CHANGED: static IP instead of dhcp4: true
            # Pick a free IP on your LAN (check your router's DHCP range to avoid conflicts)
            dhcp4: no
            addresses:
                - 192.168.1.100/24       # Static IP for the Pi
            routes:
                - to: default
                  via: 192.168.1.1       # Your router's IP (default gateway)
            nameservers:
                addresses:
                    - 8.8.8.8            # Google DNS (primary)
                    - 1.1.1.1            # Cloudflare DNS (fallback)
    version: 2

    # DO NOT MODIFY this section unless you change WiFi network
    # This keeps WiFi as a backup connection using DHCP
    wifis:
        wlan0:
            access-points:
                YOUR-WIFI-SSID:          # Replace with your actual SSID
                    auth:
                        key-management: none
            dhcp4: true
            optional: true               # Boot won't wait for WiFi if unavailable
            regulatory-domain: PT        # Country code for WiFi regulations
```

> **Important:** Only modify the `eth0` section. Keep your existing `wifis` block unchanged so you don't lose WiFi access.

Apply:

```bash
sudo netplan apply
```

> You may see `WARNING:root:Cannot call Open vSwitch: ovsdb-server.service is not running.` — this is harmless. Ubuntu checks for Open vSwitch by default even if you don't use it. Your network config applied correctly.

Verify the new IP:

```bash
ip addr show eth0
```

---

## 3. Install Docker

Install Docker using the official script:

```bash
curl -fsSL https://get.docker.com | sh
```

Add your user to the docker group (no sudo needed for docker commands):

```bash
sudo usermod -aG docker $USER
```

Apply group change without logging out:

```bash
newgrp docker
```

Install Docker Compose plugin:

```bash
sudo apt install -y docker-compose-plugin
```

Verify installation:

```bash
docker --version
```

```bash
docker compose version
```

Enable Docker to start on boot:

```bash
sudo systemctl enable docker
```

---

## 4. Install Python

Ubuntu Server should have Python 3 pre-installed. Verify:

```bash
python3 --version
```

Install venv support:

```bash
sudo apt install -y python3-pip python3-venv
```

---

## 5. Create Data Directories

The `docker-compose.override.yml` maps container volumes to `/data/` on the filesystem. These directories must exist before starting containers:

```bash
sudo mkdir -p /data/influxdb /data/influxdb-config /data/grafana /data/nodered
```

```bash
sudo chown -R $USER:$USER /data
```

---

## 6. Clone the Project

```bash
cd ~
```

```bash
git clone <your-repo-url> technological_foods
```

```bash
cd technological_foods
```

---

## 7. Configure Environment Variables

Since we're not cloning the repo yet, create the `.env` file manually:

```bash
mkdir -p ~/technological_foods/backend
```

```bash
nano ~/technological_foods/backend/.env
```

Paste the full config below. Replace values marked with `CHANGE_ME` with your actual values:

```bash
# InfluxDB Configuration
INFLUXDB_URL=http://localhost:8086
INFLUXDB_USERNAME=admin
INFLUXDB_PASSWORD=agritech2026
INFLUXDB_ORG=agritech
INFLUXDB_BUCKET=hydroponics
INFLUXDB_TOKEN=CHANGE_ME
```

> **Important:** `INFLUXDB_TOKEN` must be an **All Access API Token** from InfluxDB UI > Data > API Tokens. The token generated during onboarding is read-only and will cause `403 Forbidden` errors.

```bash
# Grafana Configuration
GRAFANA_USER=admin
GRAFANA_PASSWORD=agritech2026
```

```bash
# Node-RED
NODERED_URL=http://localhost:1880
```

```bash
# HTTP API Server
HTTP_PORT=3001
```

```bash
# API Authentication (must match API_KEY in Arduino config.h)
API_KEY=agritech-secret-key-2026
```

```bash
# Notification Service — cooldown in seconds between repeated alerts
NOTIFICATION_COOLDOWN=900
```

```bash
# ntfy push notifications
NTFY_URL=https://ntfy.sh
NTFY_TOPIC=techfoods
NTFY_TOKEN=
```

```bash
# Haier AC (hOn) — leave HON_PASSWORD empty to disable
HON_EMAIL=atopedro@gmail.com
HON_PASSWORD=
```

### Optional variables (uncomment and fill to enable)

```bash
# Twilio (WhatsApp / SMS)
# TWILIO_ACCOUNT_SID=
# TWILIO_AUTH_TOKEN=
# TWILIO_WHATSAPP_FROM=+14155238886
# TWILIO_WHATSAPP_TO=+351XXXXXXXXX
# TWILIO_SMS_FROM=
# TWILIO_SMS_TO=
```

```bash
# Email (SMTP)
# SMTP_HOST=
# SMTP_USER=
# SMTP_PASS=
# ALERT_EMAIL_TO=
```

### How to get the InfluxDB token

1. Open `http://192.168.1.100:8086` in your browser
2. Go to **Data** (left sidebar) > **API Tokens**
3. Click **Generate API Token** > **All Access API Token**
4. Name it (e.g. `ArduinoUNOR4Wifi`) and save
5. Copy the token and paste it as `INFLUXDB_TOKEN` in the `.env` file

---

## 8. Start Docker Services

```bash
cd ~/technological_foods/backend
```

Start all containers (override file is auto-merged, applying RPi optimizations):

```bash
docker compose up -d
```

Verify containers are running:

```bash
docker compose ps
```

Watch InfluxDB startup (wait for "Listening ... addr=:8086", then Ctrl+C):

```bash
docker compose logs -f influxdb
```

Verify InfluxDB:

```bash
curl -s http://localhost:8086/health
```

Verify Grafana:

```bash
curl -s http://localhost:3000/api/health
```

Verify Node-RED:

```bash
curl -s http://localhost:1880/
```

---

## 9. Set Up the Python API

```bash
cd ~/technological_foods/backend/api
```

Create virtual environment:

```bash
python3 -m venv venv
```

```bash
source venv/bin/activate
```

Install dependencies:

```bash
pip install -r requirements.txt
```

Test that it starts (Ctrl+C to stop after verifying):

```bash
python server.py
```

You should see:

```
Server running at http://0.0.0.0:3001
Swagger UI: http://localhost:3001/api/docs
```

---

## 10. Create systemd Service for the API

This makes the API auto-start on boot and auto-restart on crash.

```bash
sudo nano /etc/systemd/system/agritech-api.service
```

Paste the following (replace `<your-username>` with your actual username):

```ini
[Unit]
Description=AgriTech Hydroponics API Server
After=network.target docker.service
Wants=docker.service

[Service]
Type=simple
User=<your-username>
WorkingDirectory=/home/<your-username>/technological_foods/backend/api
Environment=PATH=/home/<your-username>/technological_foods/backend/api/venv/bin:/usr/bin
EnvironmentFile=/home/<your-username>/technological_foods/backend/.env
ExecStart=/home/<your-username>/technological_foods/backend/api/venv/bin/python server.py
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

Reload systemd:

```bash
sudo systemctl daemon-reload
```

Enable on boot:

```bash
sudo systemctl enable agritech-api
```

Start the service:

```bash
sudo systemctl start agritech-api
```

Check status:

```bash
sudo systemctl status agritech-api
```

---

## 11. Auto-start Docker Compose on Boot

Docker containers with `restart: unless-stopped` will auto-restart as long as Docker itself starts on boot (already enabled in step 3). No extra systemd service is needed for the containers.

Verify after reboot:

```bash
sudo reboot
```

After reboot, SSH back in and check containers:

```bash
docker compose -f ~/technological_foods/backend/docker-compose.yml ps
```

Check API service:

```bash
sudo systemctl status agritech-api
```

All 3 containers and the API should be running.

---

## 12. SD Card Longevity Optimizations

SD cards have limited write cycles. These changes reduce unnecessary writes:

### Disable swap

```bash
sudo swapoff -a
```

```bash
sudo systemctl disable dphys-swapfile 2>/dev/null || true
```

Remove swap entry from fstab if present:

```bash
sudo sed -i '/swap/d' /etc/fstab
```

### Use tmpfs for temporary and log directories

Open fstab:

```bash
sudo nano /etc/fstab
```

Append these lines:

```
tmpfs /tmp        tmpfs defaults,noatime,nosuid,size=100m 0 0
tmpfs /var/log    tmpfs defaults,noatime,nosuid,size=50m  0 0
```

### Reduce systemd journal size

```bash
sudo nano /etc/systemd/journald.conf
```

Set:

```ini
[Journal]
SystemMaxUse=50M
MaxRetentionSec=7day
```

Apply:

```bash
sudo systemctl restart systemd-journald
```

### Mount filesystem with noatime

Edit `/etc/fstab` and add `noatime` to the root partition options:

```
PARTUUID=xxxxx  /  ext4  defaults,noatime  0  1
```

Apply on next reboot or run:

```bash
sudo mount -o remount,noatime /
```

---

## 13. Firewall

Install ufw:

```bash
sudo apt install -y ufw
```

Set default policies:

```bash
sudo ufw default deny incoming
```

```bash
sudo ufw default allow outgoing
```

Allow required ports:

```bash
sudo ufw allow 22/tcp
```

```bash
sudo ufw allow 3001/tcp
```

```bash
sudo ufw allow 3000/tcp
```

```bash
sudo ufw allow 8086/tcp
```

```bash
sudo ufw allow 1880/tcp
```

Enable firewall:

```bash
sudo ufw enable
```

Verify:

```bash
sudo ufw status
```

---

## 14. SSH Hardening

After confirming SSH key access works:

```bash
sudo nano /etc/ssh/sshd_config
```

Recommended settings:

```
PermitRootLogin no
PasswordAuthentication no
MaxAuthTries 3
```

Restart SSH:

```bash
sudo systemctl restart sshd
```

Install fail2ban:

```bash
sudo apt install -y fail2ban
```

```bash
sudo systemctl enable fail2ban
```

```bash
sudo systemctl start fail2ban
```

---

## 15. Verify Everything

Run these checks after a fresh reboot to confirm the full stack starts automatically:

All Docker containers running:

```bash
docker ps
```

API responding:

```bash
curl http://localhost:3001/api/health
```

InfluxDB healthy:

```bash
curl http://localhost:8086/health
```

Grafana accessible:

```bash
curl -s http://localhost:3000/api/health
```

Node-RED accessible:

```bash
curl -s http://localhost:1880/
```

Swagger docs:

```bash
curl -s http://localhost:3001/api/docs | head -5
```

systemd service status:

```bash
sudo systemctl status agritech-api
```

---

## 16. RAM Budget

| Component | Reserved | Max | Notes |
|-----------|----------|-----|-------|
| Ubuntu OS + system | ~500MB | ~700MB | Kernel, systemd, SSH |
| InfluxDB | 512MB | 1.5GB | Heaviest service |
| Grafana | 256MB | 512MB | Dashboard rendering |
| Node-RED | 256MB | 512MB | JS runtime, max_old_space=384MB |
| Python API | ~50MB | ~150MB | Lightweight HTTP server |
| **Total** | **~1.6GB** | **~3.4GB** | |
| **Headroom** | | **~600MB** | Buffer for spikes |

---

## 17. Port Reference

| Port | Service | Access |
|------|---------|--------|
| 22 | SSH | Remote administration |
| 3001 | API Server | Arduino data ingestion, Swagger UI |
| 8086 | InfluxDB | Time-series database |
| 3000 | Grafana | Dashboard visualization |
| 1880 | Node-RED | Flow editor |

All services bind to `0.0.0.0` and are accessible from any device on the local network at `http://<pi-ip>:<port>`.

---

## 18. Maintenance Commands

### Check resource usage

CPU and memory:

```bash
htop
```

Disk space:

```bash
df -h
```

Data directory sizes:

```bash
du -sh /data/*
```

Container resource usage:

```bash
docker stats
```

### View logs

API server logs:

```bash
journalctl -u agritech-api -n 100 -f
```

InfluxDB logs:

```bash
docker compose -f ~/technological_foods/backend/docker-compose.yml logs -f influxdb
```

Grafana logs:

```bash
docker compose -f ~/technological_foods/backend/docker-compose.yml logs -f grafana
```

Node-RED logs:

```bash
docker compose -f ~/technological_foods/backend/docker-compose.yml logs -f nodered
```

### Restart services

Restart API only:

```bash
sudo systemctl restart agritech-api
```

Restart all Docker containers:

```bash
cd ~/technological_foods/backend && docker compose restart
```

Restart a single container:

```bash
docker restart agritech-influxdb
```

### Update the project

```bash
cd ~/technological_foods
```

```bash
git pull
```

Install deps if changed:

```bash
pip install -r backend/api/requirements.txt
```

Restart API:

```bash
sudo systemctl restart agritech-api
```

Rebuild containers if compose files changed:

```bash
cd backend && docker compose up -d
```

---

## 19. Troubleshooting

### API won't start

Check the logs:

```bash
journalctl -u agritech-api -n 50
```

Run manually to see errors:

```bash
cd ~/technological_foods/backend/api
```

```bash
source venv/bin/activate
```

```bash
python server.py
```

Common cause — InfluxDB not ready yet. Check:

```bash
curl http://localhost:8086/health
```

### Docker containers not starting

```bash
cd ~/technological_foods/backend
```

```bash
docker compose logs
```

Run in foreground to see errors:

```bash
docker compose up
```

### Out of memory

```bash
free -h
```

```bash
docker stats --no-stream
```

If InfluxDB is using too much memory, restart it:

```bash
docker restart agritech-influxdb
```

### SD card running out of space

```bash
df -h
```

```bash
du -sh /data/*
```

Clean Docker cache:

```bash
docker system prune -f
```

Check log sizes:

```bash
du -sh /var/log/*
```

> Reduce InfluxDB retention if needed (inside the InfluxDB UI at `:8086`)

### Can't reach services from another machine

Check firewall:

```bash
sudo ufw status
```

Check services are listening on `0.0.0.0` (not just `127.0.0.1`):

```bash
ss -tlnp | grep -E '3001|8086|3000|1880'
```

Check Pi's IP:

```bash
ip addr show
```
