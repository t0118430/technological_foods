name: Deploy Arduino Firmware (OTA)

on:
  push:
    branches:
      - master
    paths:
      - 'arduino/**'
      - '.github/workflows/deploy-arduino-ota.yml'
  workflow_dispatch:
    inputs:
      arduino_ip:
        description: 'Arduino IP address (optional, uses default from secrets)'
        required: false
        type: string

env:
  ARDUINO_CLI_VERSION: '0.35.3'

jobs:
  build-firmware:
    name: Build Arduino Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Install Arduino R4 WiFi core
        run: |
          arduino-cli config init
          arduino-cli core update-index
          arduino-cli core install arduino:renesas_uno

      - name: Install required libraries
        run: |
          arduino-cli lib install "DHT sensor library"
          arduino-cli lib install "Adafruit Unified Sensor"
          arduino-cli lib install "ArduinoHttpClient"
          arduino-cli lib install "WiFiS3"
          arduino-cli lib install "ArduinoJson"

      - name: Validate sketch
        run: |
          cd arduino/temp_hum_light_sending_api
          arduino-cli compile --fqbn arduino:renesas_uno:unor4wifi --warnings all

      - name: Build firmware binary
        run: |
          cd arduino/temp_hum_light_sending_api
          arduino-cli compile --fqbn arduino:renesas_uno:unor4wifi --output-dir ../../build/arduino
          ls -lh ../../build/arduino/

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v3
        with:
          name: arduino-firmware
          path: build/arduino/*.bin
          retention-days: 30

      - name: Calculate firmware hash
        run: |
          cd build/arduino
          sha256sum *.bin > firmware.sha256
          cat firmware.sha256

  deploy-ota:
    name: Deploy via OTA
    needs: build-firmware
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download firmware artifact
        uses: actions/download-artifact@v3
        with:
          name: arduino-firmware
          path: firmware/

      - name: Setup Python for OTA script
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install OTA dependencies
        run: |
          pip install requests pyserial

      - name: Deploy firmware via OTA
        env:
          ARDUINO_IP: ${{ inputs.arduino_ip || secrets.ARDUINO_IP }}
          ARDUINO_OTA_PASSWORD: ${{ secrets.ARDUINO_OTA_PASSWORD }}
        run: |
          cd arduino/ota-tools
          python deploy_ota.py \
            --ip "$ARDUINO_IP" \
            --password "$ARDUINO_OTA_PASSWORD" \
            --firmware "../../firmware/temp_hum_light_sending_api.ino.bin"

      - name: Verify deployment
        env:
          ARDUINO_IP: ${{ inputs.arduino_ip || secrets.ARDUINO_IP }}
        run: |
          echo "Waiting for Arduino to restart..."
          sleep 10

          echo "Checking Arduino health endpoint..."
          curl -s http://$ARDUINO_IP/health || echo "Health check endpoint not available (normal for basic firmware)"

          echo "âœ… Deployment complete!"

      - name: Send success notification
        if: success()
        run: |
          curl -H "Title: Arduino Firmware Deployed" \
               -H "Tags: robot,white_check_mark" \
               -H "Priority: default" \
               -d "Arduino firmware successfully deployed via OTA to ${{ secrets.ARDUINO_IP }}" \
               ${{ secrets.NTFY_TOPIC_URL }} || true

      - name: Send failure notification
        if: failure()
        run: |
          curl -H "Title: Arduino Deployment Failed" \
               -H "Tags: robot,warning" \
               -H "Priority: high" \
               -d "Arduino OTA deployment failed. May need manual USB flash." \
               ${{ secrets.NTFY_TOPIC_URL }} || true

  create-release:
    name: Create Firmware Release
    needs: deploy-ota
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download firmware artifact
        uses: actions/download-artifact@v3
        with:
          name: arduino-firmware
          path: firmware/

      - name: Get version from sketch
        id: version
        run: |
          VERSION=$(grep "const char\* FIRMWARE_VERSION" arduino/temp_hum_light_sending_api/temp_hum_light_sending_api.ino | cut -d'"' -f2 || echo "1.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION"

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: arduino-v${{ steps.version.outputs.version }}
          name: Arduino Firmware v${{ steps.version.outputs.version }}
          body: |
            ## Arduino R4 WiFi Firmware Release

            **Version**: ${{ steps.version.outputs.version }}
            **Commit**: ${{ github.sha }}
            **Date**: ${{ github.event.head_commit.timestamp }}

            ### Changes
            ${{ github.event.head_commit.message }}

            ### Installation

            **OTA Update** (Recommended):
            ```bash
            cd arduino/ota-tools
            python deploy_ota.py --ip <arduino-ip> --firmware temp_hum_light_sending_api.ino.bin
            ```

            **USB Flash**:
            ```bash
            arduino-cli upload --fqbn arduino:renesas_uno:unor4wifi --port <port> --input-file temp_hum_light_sending_api.ino.bin
            ```
          files: |
            firmware/*.bin
            firmware/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
