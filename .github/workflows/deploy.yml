name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  ARDUINO_CLI_VERSION: '0.35.3'

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      arduino: ${{ steps.filter.outputs.arduino }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            arduino:
              - 'arduino/**'
            infra:
              - 'infra/**'

  deploy-backend:
    name: Deploy Backend to Raspberry Pi
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.infra == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend/api
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run quick sanity tests
        run: |
          cd backend/api
          python -m py_compile *.py
          python -m json.tool ../config/base_hydroponics.json > /dev/null
          pytest test_*.py -v --cov=. --cov-report=term-missing || true

      - name: Validate docker-compose
        run: |
          cd backend
          docker-compose config > /dev/null

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup on Pi
        run: |
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
            "cd ${{ secrets.PI_PROJECT_PATH }} && ./deploy/backup.sh pre-deploy"

      - name: Deploy backend files to Pi
        if: needs.detect-changes.outputs.backend == 'true'
        run: |
          rsync -avz --exclude='data' --exclude='*.log' \
            -e "ssh -i ~/.ssh/id_rsa" \
            backend/ ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:${{ secrets.PI_PROJECT_PATH }}/backend/

      - name: Deploy infra files to Pi
        if: needs.detect-changes.outputs.infra == 'true'
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/id_rsa" \
            infra/ ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:${{ secrets.PI_PROJECT_PATH }}/infra/

      - name: Restart services on Pi
        run: |
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'ENDSSH'
            cd ${{ secrets.PI_PROJECT_PATH }}

            cd backend
            docker-compose pull
            docker-compose up -d --remove-orphans

            sudo systemctl restart agritech-api.service

            sleep 10
          ENDSSH

      - name: Health check
        id: health_check
        run: |
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'ENDSSH'
            cd ${{ secrets.PI_PROJECT_PATH }}
            ./deploy/health-check.sh
          ENDSSH

      - name: Rollback on failure
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'ENDSSH'
            cd ${{ secrets.PI_PROJECT_PATH }}
            echo "Deployment failed, rolling back..."
            ./deploy/restore.sh pre-deploy
            sudo systemctl restart agritech-api.service
            cd backend && docker-compose restart
          ENDSSH

      - name: Send backend deploy notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            curl -H "Title: Backend Deployed to Pi" \
                 -H "Tags: white_check_mark,raspberry_pi" \
                 -H "Priority: default" \
                 -d "Backend successfully deployed to Raspberry Pi at $(date)" \
                 ${{ secrets.NTFY_TOPIC_URL }} || true
          else
            curl -H "Title: Backend Deploy Failed" \
                 -H "Tags: warning,raspberry_pi" \
                 -H "Priority: high" \
                 -d "Backend deployment to Raspberry Pi failed. Check GitHub Actions logs." \
                 ${{ secrets.NTFY_TOPIC_URL }} || true
          fi

  deploy-arduino:
    name: Deploy Arduino Firmware
    needs: detect-changes
    if: needs.detect-changes.outputs.arduino == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Install Arduino R4 WiFi core
        run: |
          arduino-cli config init
          arduino-cli core update-index
          arduino-cli core install arduino:renesas_uno

      - name: Install required libraries
        run: |
          arduino-cli lib install "DHT sensor library"
          arduino-cli lib install "Adafruit Unified Sensor"
          arduino-cli lib install "ArduinoHttpClient"
          arduino-cli lib install "WiFiS3"
          arduino-cli lib install "ArduinoJson"

      - name: Build firmware binary
        run: |
          cd arduino/temp_hum_light_sending_api
          arduino-cli compile --fqbn arduino:renesas_uno:unor4wifi --warnings all --output-dir ../../build/arduino
          ls -lh ../../build/arduino/

      - name: Calculate firmware hash
        run: |
          cd build/arduino
          sha256sum *.bin > firmware.sha256
          cat firmware.sha256

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: arduino-firmware
          path: build/arduino/*.bin
          retention-days: 30

      - name: Setup Python for OTA
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install OTA dependencies
        run: pip install requests pyserial

      - name: Deploy firmware via OTA
        env:
          ARDUINO_IP: ${{ secrets.ARDUINO_IP }}
          ARDUINO_OTA_PASSWORD: ${{ secrets.ARDUINO_OTA_PASSWORD }}
        run: |
          cd arduino/ota-tools
          python deploy_ota.py \
            --ip "$ARDUINO_IP" \
            --password "$ARDUINO_OTA_PASSWORD" \
            --firmware "../../build/arduino/temp_hum_light_sending_api.ino.bin"

      - name: Verify deployment
        env:
          ARDUINO_IP: ${{ secrets.ARDUINO_IP }}
        run: |
          echo "Waiting for Arduino to restart..."
          sleep 10
          echo "Checking Arduino health endpoint..."
          curl -s http://$ARDUINO_IP/health || echo "Health check endpoint not available (normal for basic firmware)"

      - name: Get firmware version
        id: version
        run: |
          VERSION=$(grep "const char\* FIRMWARE_VERSION" arduino/temp_hum_light_sending_api/temp_hum_light_sending_api.ino | cut -d'"' -f2 || echo "1.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: arduino-v${{ steps.version.outputs.version }}
          name: Arduino Firmware v${{ steps.version.outputs.version }}
          body: |
            ## Arduino R4 WiFi Firmware Release

            **Version**: ${{ steps.version.outputs.version }}
            **Commit**: ${{ github.sha }}
            **Date**: ${{ github.event.head_commit.timestamp }}

            ### Changes
            ${{ github.event.head_commit.message }}

            ### Installation

            **OTA Update** (Recommended):
            ```bash
            cd arduino/ota-tools
            python deploy_ota.py --ip <arduino-ip> --firmware temp_hum_light_sending_api.ino.bin
            ```

            **USB Flash**:
            ```bash
            arduino-cli upload --fqbn arduino:renesas_uno:unor4wifi --port <port> --input-file temp_hum_light_sending_api.ino.bin
            ```
          files: |
            build/arduino/*.bin
            build/arduino/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send arduino deploy notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            curl -H "Title: Arduino Firmware Deployed" \
                 -H "Tags: robot,white_check_mark" \
                 -H "Priority: default" \
                 -d "Arduino firmware v${{ steps.version.outputs.version }} deployed via OTA to ${{ secrets.ARDUINO_IP }}" \
                 ${{ secrets.NTFY_TOPIC_URL }} || true
          else
            curl -H "Title: Arduino Deploy Failed" \
                 -H "Tags: robot,warning" \
                 -H "Priority: high" \
                 -d "Arduino OTA deployment failed. May need manual USB flash." \
                 ${{ secrets.NTFY_TOPIC_URL }} || true
          fi

  notify:
    name: Deployment Summary
    needs: [detect-changes, deploy-backend, deploy-arduino]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Build summary
        run: |
          BACKEND="${{ needs.detect-changes.outputs.backend }}"
          ARDUINO="${{ needs.detect-changes.outputs.arduino }}"
          INFRA="${{ needs.detect-changes.outputs.infra }}"

          BACKEND_STATUS="${{ needs.deploy-backend.result }}"
          ARDUINO_STATUS="${{ needs.deploy-arduino.result }}"

          SUMMARY="Deployment Summary for ${{ github.sha }}:"
          SUMMARY="$SUMMARY\n"

          if [ "$BACKEND" == "true" ] || [ "$INFRA" == "true" ]; then
            SUMMARY="$SUMMARY\nRaspberry Pi (backend/infra): $BACKEND_STATUS"
          else
            SUMMARY="$SUMMARY\nRaspberry Pi (backend/infra): skipped (no changes)"
          fi

          if [ "$ARDUINO" == "true" ]; then
            SUMMARY="$SUMMARY\nArduino (firmware): $ARDUINO_STATUS"
          else
            SUMMARY="$SUMMARY\nArduino (firmware): skipped (no changes)"
          fi

          echo -e "$SUMMARY"

          # Determine overall status
          TITLE="Deployment Complete"
          TAGS="white_check_mark"
          PRIORITY="default"

          if [ "$BACKEND_STATUS" == "failure" ] || [ "$ARDUINO_STATUS" == "failure" ]; then
            TITLE="Deployment Partially Failed"
            TAGS="warning"
            PRIORITY="high"
          fi

          curl -H "Title: $TITLE" \
               -H "Tags: $TAGS" \
               -H "Priority: $PRIORITY" \
               -d "$(echo -e "$SUMMARY")" \
               ${{ secrets.NTFY_TOPIC_URL }} || true
